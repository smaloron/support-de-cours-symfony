<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-02-01T10:46:57.428868"><title>La classe QueryBuilder | Symfony support</title><script type="application/json" id="virtual-toc-data">[{"id":"objectifs","level":0,"title":"Objectifs","anchor":"#objectifs"},{"id":"principe","level":0,"title":"Principe","anchor":"#principe"},{"id":"notre-bac-sable","level":0,"title":"Notre bac à sable","anchor":"#notre-bac-sable"},{"id":"quelques-requ-tes","level":0,"title":"Quelques requêtes","anchor":"#quelques-requ-tes"},{"id":"les-m-thodes-du-querybuilder","level":0,"title":"Les Méthodes du QueryBuilder","anchor":"#les-m-thodes-du-querybuilder"},{"id":"group-by","level":0,"title":"Group By","anchor":"#group-by"},{"id":"la-r-cup-ration-des-r-sultats","level":0,"title":"La récupération des résultats","anchor":"#la-r-cup-ration-des-r-sultats"},{"id":"exercices","level":0,"title":"Exercices","anchor":"#exercices"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b575/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="La classe QueryBuilder | Symfony support"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Symfony support Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation//version 1/004-06-querybuilder.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="La classe QueryBuilder | Symfony support"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation//version 1/004-06-querybuilder.html#webpage",
    "url": "writerside-documentation//version 1/004-06-querybuilder.html",
    "name": "La classe QueryBuilder | Symfony support",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Symfony support Help"
}</script><!-- End Schema.org --></head><body data-id="004-06-QueryBuilder" data-main-title="La classe QueryBuilder" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="004-00-doctrine.md|Doctrine"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Symfony support version 1 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="004-06-QueryBuilder" id="004-06-QueryBuilder.md">La classe QueryBuilder</h1><section class="chapter"><h2 id="objectifs" data-toc="objectifs">Objectifs</h2><ul class="list _bullet" id="bqkqde_11"><li class="list__item" id="bqkqde_12"><p>Identifier le r&ocirc;le du <code class="code" id="bqkqde_14">QueryBuilder</code>.</p></li><li class="list__item" id="bqkqde_13"><p>Ajouter des requ&ecirc;tes personnalis&eacute;es au <code class="code" id="bqkqde_15">Repository</code> des entit&eacute;s.</p></li></ul></section><section class="chapter"><h2 id="principe" data-toc="principe">Principe</h2><p id="bqkqde_16">Comme son nom l'indique la classe <code class="code" id="bqkqde_21">QueryBuilder</code>, permet de cr&eacute;er des requ&ecirc;tes et d'aller au-del&agrave; de ce que proposent les fonctions de base du <code class="code" id="bqkqde_22">Repository</code>.</p><p id="bqkqde_17">S'il est possible de cr&eacute;er une requ&ecirc;te dans un contr&ocirc;leur ou dans n'importe quel autre classe d'ailleurs, il est n&eacute;anmoins fortement conseill&eacute; de centraliser les requ&ecirc;tes dans les classes <code class="code" id="bqkqde_23">Repository</code>. De cette fa&ccedil;on, nous saurons exactement o&ugrave; chercher les requ&ecirc;tes si jamais nous avons une modification &agrave; effectuer.</p><section class="chapter"><h3 id="obtenir-un-instance-de-querybuilder" data-toc="obtenir-un-instance-de-querybuilder">Obtenir un instance de QueryBuilder</h3></section><section class="chapter"><h3 id="depuis-une-classe-repository" data-toc="depuis-une-classe-repository">Depuis une classe <code class="code" id="bqkqde_27">Repository</code></h3><div class="code-block" data-lang="php">
$qb = $this-&gt;createQueryBuilder('a')
</div><p id="bqkqde_26">Le param&egrave;tre pass&eacute; &agrave; la m&eacute;thode repr&eacute;sente l'alias de la classe &agrave; laquelle le <code class="code" id="bqkqde_28">Repository</code> est li&eacute;.</p></section><section class="chapter"><h3 id="depuis-n-importe-o" data-toc="depuis-n-importe-o">Depuis n'importe o&ugrave;</h3><p id="bqkqde_29">Il nous faut une instance de la classe <code class="code" id="bqkqde_32">EntityManager</code> et il faut &eacute;galement pr&eacute;ciser l'entit&eacute; sur laquelle nous souhaitons requ&ecirc;ter.</p><p id="bqkqde_30">Cette fa&ccedil;on de faire n'est cependant pas recommand&eacute;e car on ne centralise pas les requ&ecirc;tes.</p><div class="code-block" data-lang="php">
public function query(
    EntityManagerInterface $manager)
{
    $qb = $manager-&gt;createQueryBuilder();
    $qb-&gt;select('u')-&gt;from(User::class, 'u');
}
</div></section></section><section class="chapter"><h2 id="notre-bac-sable" data-toc="notre-bac-sable">Notre bac &agrave; sable</h2><p id="bqkqde_33">Nous pouvons cloner ou t&eacute;l&eacute;charger le projet suivant pour nous entrainer &agrave; utiliser le QuerBuilder.</p><p id="bqkqde_34"><a href="https://github.com/smaloron/symfony-blog" id="bqkqde_37" data-external="true" rel="noopener noreferrer">Projet Blog</a></p><section class="chapter"><h3 id="la-mise-en-place" data-toc="la-mise-en-place">La Mise en place</h3><div class="code-block" data-lang="bash">
composer install
</div><div class="code-block" data-lang="bash">
docker compose up -d
</div><div class="code-block" data-lang="bash">
symfony console doctrine:migrations:migrate
</div><div class="code-block" data-lang="bash">
symfony console doctrine:fixtures:load
</div></section><section class="chapter"><h3 id="le-diagramme-de-classe" data-toc="le-diagramme-de-classe">Le diagramme de classe</h3><style>.theme-dark .plantuml > svg {filter: hue-rotate(180deg) invert(0.9);}div.plantuml {overflow-x: auto;}</style><div class="plantuml"><?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="573px" preserveAspectRatio="none" style="width:590px;height:573px;background:#FFFFFF;" version="1.1" viewBox="0 0 590 573" width="590px" zoomAndPan="magnify"><defs/><g><!--class User--><g id="elem_User"><rect codeLine="5" fill="#F1F1F1" height="113.9531" id="User" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="131" x="408.5" y="7"/><ellipse cx="454.25" cy="23" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M457.2231,28.6431 Q456.6421,28.9419 456.0029,29.0913 Q455.3638,29.2407 454.6582,29.2407 Q452.1514,29.2407 450.8315,27.5889 Q449.5117,25.937 449.5117,22.8159 Q449.5117,19.6865 450.8315,18.0347 Q452.1514,16.3828 454.6582,16.3828 Q455.3638,16.3828 456.0112,16.5322 Q456.6587,16.6816 457.2231,16.9805 L457.2231,19.7031 Q456.5923,19.1221 455.9988,18.8523 Q455.4053,18.5825 454.7744,18.5825 Q453.4297,18.5825 452.7449,19.6492 Q452.0601,20.7158 452.0601,22.8159 Q452.0601,24.9077 452.7449,25.9744 Q453.4297,27.041 454.7744,27.041 Q455.4053,27.041 455.9988,26.7712 Q456.5923,26.5015 457.2231,25.9204 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="474.75" y="28.291">User</text><line style="stroke:#181818;stroke-width:0.5;" x1="409.5" x2="538.5" y1="39" y2="39"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="414.5" y="56.5352">id : integer</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="118" x="414.5" y="73.0234">firstName : string</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="115" x="414.5" y="89.5117">lastName : string</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="119" x="414.5" y="106">nickName : string</text><line style="stroke:#181818;stroke-width:0.5;" x1="409.5" x2="538.5" y1="112.9531" y2="112.9531"/></g><!--class PostTheme--><g id="elem_PostTheme"><rect codeLine="12" fill="#F1F1F1" height="97.4648" id="PostTheme" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="218" x="365" y="469.25"/><ellipse cx="431.75" cy="485.25" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M434.7231,490.8931 Q434.1421,491.1919 433.5029,491.3413 Q432.8638,491.4907 432.1582,491.4907 Q429.6514,491.4907 428.3315,489.8389 Q427.0117,488.187 427.0117,485.0659 Q427.0117,481.9365 428.3315,480.2847 Q429.6514,478.6328 432.1582,478.6328 Q432.8638,478.6328 433.5112,478.7822 Q434.1587,478.9316 434.7231,479.2305 L434.7231,481.9531 Q434.0923,481.3721 433.4988,481.1023 Q432.9053,480.8325 432.2744,480.8325 Q430.9297,480.8325 430.2449,481.8992 Q429.5601,482.9658 429.5601,485.0659 Q429.5601,487.1577 430.2449,488.2244 Q430.9297,489.291 432.2744,489.291 Q432.9053,489.291 433.4988,489.0212 Q434.0923,488.7515 434.7231,488.1704 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="76" x="452.25" y="490.541">PostTheme</text><line style="stroke:#181818;stroke-width:0.5;" x1="366" x2="582" y1="501.25" y2="501.25"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="371" y="518.7852">id : integer</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="371" y="535.2734">themeName : string</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="366" x2="582" y1="542.2266" y2="542.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="206" x="371" y="559.7617">posts : ArrayCollection&lt;Post&gt;</text></g><!--class Tag--><g id="elem_Tag"><rect codeLine="19" fill="#F1F1F1" height="97.4648" id="Tag" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="218" x="365" y="337.25"/><ellipse cx="456.75" cy="353.25" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M459.7231,358.8931 Q459.1421,359.1919 458.5029,359.3413 Q457.8638,359.4907 457.1582,359.4907 Q454.6514,359.4907 453.3315,357.8389 Q452.0117,356.187 452.0117,353.0659 Q452.0117,349.9365 453.3315,348.2847 Q454.6514,346.6328 457.1582,346.6328 Q457.8638,346.6328 458.5112,346.7822 Q459.1587,346.9316 459.7231,347.2305 L459.7231,349.9531 Q459.0923,349.3721 458.4988,349.1023 Q457.9053,348.8325 457.2744,348.8325 Q455.9297,348.8325 455.2449,349.8992 Q454.5601,350.9658 454.5601,353.0659 Q454.5601,355.1577 455.2449,356.2244 Q455.9297,357.291 457.2744,357.291 Q457.9053,357.291 458.4988,357.0212 Q459.0923,356.7515 459.7231,356.1704 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="26" x="477.25" y="358.541">Tag</text><line style="stroke:#181818;stroke-width:0.5;" x1="366" x2="582" y1="369.25" y2="369.25"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="371" y="386.7852">id : integer</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="113" x="371" y="403.2734">tagName : string</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="366" x2="582" y1="410.2266" y2="410.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="206" x="371" y="427.7617">posts : ArrayCollection&lt;Post&gt;</text></g><!--class Comment--><g id="elem_Comment"><rect codeLine="26" fill="#F1F1F1" height="146.9297" id="Comment" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="155" x="396.5" y="155.51"/><ellipse cx="436.7" cy="171.51" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M439.6731,177.1531 Q439.0921,177.4519 438.4529,177.6013 Q437.8138,177.7507 437.1082,177.7507 Q434.6014,177.7507 433.2815,176.0989 Q431.9617,174.447 431.9617,171.3259 Q431.9617,168.1965 433.2815,166.5447 Q434.6014,164.8928 437.1082,164.8928 Q437.8138,164.8928 438.4612,165.0422 Q439.1087,165.1916 439.6731,165.4905 L439.6731,168.2131 Q439.0423,167.6321 438.4488,167.3623 Q437.8553,167.0925 437.2244,167.0925 Q435.8797,167.0925 435.1949,168.1592 Q434.5101,169.2258 434.5101,171.3259 Q434.5101,173.4177 435.1949,174.4844 Q435.8797,175.551 437.2244,175.551 Q437.8553,175.551 438.4488,175.2812 Q439.0423,175.0115 439.6731,174.4304 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="67" x="456.3" y="176.801">Comment</text><line style="stroke:#181818;stroke-width:0.5;" x1="397.5" x2="550.5" y1="187.51" y2="187.51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="402.5" y="205.0452">id : integer</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="402.5" y="221.5334">author : string</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="402.5" y="238.0217">content : text</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="143" x="402.5" y="254.51">createdAt : DateTime</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="102" x="402.5" y="270.9983">rating : integer</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="397.5" x2="550.5" y1="277.9514" y2="277.9514"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="71" x="402.5" y="295.4866">post : Post</text></g><!--class Post--><g id="elem_Post"><rect codeLine="36" fill="#F1F1F1" height="196.3945" id="Post" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="290" x="7" y="148.98"/><ellipse cx="133.25" cy="164.98" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M136.2231,170.6231 Q135.6421,170.9219 135.0029,171.0713 Q134.3638,171.2207 133.6582,171.2207 Q131.1514,171.2207 129.8315,169.5689 Q128.5117,167.917 128.5117,164.7959 Q128.5117,161.6665 129.8315,160.0147 Q131.1514,158.3628 133.6582,158.3628 Q134.3638,158.3628 135.0112,158.5122 Q135.6587,158.6616 136.2231,158.9605 L136.2231,161.6831 Q135.5923,161.1021 134.9988,160.8323 Q134.4053,160.5625 133.7744,160.5625 Q132.4297,160.5625 131.7449,161.6292 Q131.0601,162.6958 131.0601,164.7959 Q131.0601,166.8877 131.7449,167.9544 Q132.4297,169.021 133.7744,169.021 Q134.4053,169.021 134.9988,168.7512 Q135.5923,168.4815 136.2231,167.9004 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="29" x="153.75" y="170.271">Post</text><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="296" y1="180.98" y2="180.98"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="13" y="198.5152">id : integer</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="13" y="215.0034">content : text</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="143" x="13" y="231.4917">createdAt : DateTime</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="149" x="13" y="247.98">updatedAt : DateTime</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="160" x="13" y="264.4683">publishedAt : DateTime</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="8" x2="296" y1="271.4214" y2="271.4214"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="13" y="288.9566">author : User</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="278" x="13" y="305.4448">comments : ArrayCollection&lt;Comment&gt;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="195" x="13" y="321.9331">tags : ArrayCollection&lt;Tag&gt;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="102" x="13" y="338.4214">theme : Theme</text></g><!--reverse link Post to User--><g id="link_Post_User"><path codeLine="49" d="M310,282.98 C380.99,282.98 319.19,192.21 365,137.98 C377.1,123.65 392.62,110.88 408.09,100.14 " fill="none" id="Post-backto-User" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="298,282.98,304,286.98,310,282.98,304,278.98,298,282.98" style="stroke:#181818;stroke-width:1.0;"/></g><!--reverse link Post to PostTheme--><g id="link_Post_PostTheme"><path codeLine="50" d="M310,331.98 C371.08,331.98 322.67,407.94 365,451.98 C370.71,457.92 377.07,463.53 383.75,468.79 " fill="none" id="Post-backto-PostTheme" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="298,331.98,304,335.98,310,331.98,304,327.98,298,331.98" style="stroke:#181818;stroke-width:1.0;"/></g><!--reverse link Post to Tag--><g id="link_Post_Tag"><path codeLine="51" d="M310,315.98 C340.27,315.98 359.51,325.12 387.07,336.79 " fill="none" id="Post-backto-Tag" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="298,315.98,304,319.98,310,315.98,304,311.98,298,315.98" style="stroke:#181818;stroke-width:1.0;"/></g><!--reverse link Post to Comment--><g id="link_Post_Comment"><path codeLine="52" d="M310,298.98 C343.7,298.98 366.62,287.65 396.31,274.1 " fill="none" id="Post-backto-Comment" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="298,298.98,304,302.98,310,298.98,304,294.98,298,298.98" style="stroke:#181818;stroke-width:1.0;"/></g><!--SRC=[dP9DJiCm48NtFeKlq1uWGf6giaOimW5SP-fO97OqdaWWnDsPgTsKk5qWTj7tnk_DJqOuawQeqRk1TEyHBFaObBAZIKc_9K3zfNol6-q3WGDKPu-9Nim4p1AX3qvnRKM2j-zRydtrV8s9kW5Ogun9uFRHVgzcBazC3eZcynZ7CNVu93RjpRKpxixFkF-w7UCqGQ3QqImqHBmPsiW2bpMQu8EKHJ04_K70CtzrVWA5XhZqbqdfWec4RlTI1_ubO9dxUpWlfz6deSQSlSuWj-M0ow2FLb9sqCeU7-cyyJRVZCNBGMKMcQ9fIaZSxN9CfhbOuFeFN1M9485D2rex4rnwKJy0]--></g></svg></div></section></section><section class="chapter"><h2 id="quelques-requ-tes" data-toc="quelques-requ-tes">Quelques requ&ecirc;tes</h2><section class="chapter"><h3 id="une-premi-re-requ-te-simple" data-toc="une-premi-re-requ-te-simple">Une premi&egrave;re requ&ecirc;te simple</h3><div class="code-block" data-lang="php">
// dans scr/Repository/PostRepository.php

public function findUnpublishedPosts(): array{
    // Création du QueryBuilder 
    // où p est un alias de l'entité Post
    $qb = $this -&gt;createQueryBuilder('p');
    
    // Ajout dune clause WHERE
    // notons que nous utilisons les noms 
    // des propriétés de la classe
    // et pas ceux des colonnes
    $qb-&gt;where('p.publishedAt IS NULL');
    
    // Exécute la requête et retourne le résultat
    return $qb-&gt;getQuery()-&gt;getResult();
}
</div><p id="bqkqde_48"><span class="control" id="bqkqde_54">Utilisation dans un contr&ocirc;leur</span></p><div class="code-block" data-lang="php">
// Dans src/Controller/PostController.php

#[Route('/post', name: 'app_post')]
    public function index(
        PostRepository $repository
    ): Response
    {

        $unpublished = $repository-&gt;findBy(['publishedAt' =&gt; null]);

        return $this-&gt;render('post/index.html.twig', [
            'unpublished' =&gt; $repository-&gt;findUnpublishedPosts(),
            'unpublished2' =&gt; $unpublished,
        ]);
    }
</div><p id="bqkqde_50">Comme nous le voyons, nous aurions pu obtenir le m&ecirc;me r&eacute;sultat avec une m&eacute;thode <code class="code" id="bqkqde_55">findBy</code>. Ici l'int&eacute;r&ecirc;t du <code class="code" id="bqkqde_56">QueryBuilder</code> r&eacute;side dans l'auto documentation du code.</p><p id="bqkqde_51">L'appel &agrave; <code class="code" id="bqkqde_57">findUnpublishedPosts</code> est plus explicite et peut-&ecirc;tre que plus tard, nous voudrons changer les r&egrave;gles de s&eacute;lection des posts non publi&eacute;s.</p><figure id="bqkqde_52"><img alt="CleanShot 2025-01-27 at 12.54.57@2x.png" src="images/CleanShot%202025-01-27%20at%2012.54.57%402x.png" title="CleanShot 2025-01-27 at 12.54.57@2x.png" width="1372" height="1364"></figure><p id="bqkqde_53">Nous constatons ici que la requ&ecirc;te retourne un tableau d'entit&eacute;s</p></section><section class="chapter"><h3 id="requ-te-param-tr-e" data-toc="requ-te-param-tr-e">Requ&ecirc;te param&egrave;tr&eacute;e</h3><p id="bqkqde_58">Pour &eacute;viter les probl&egrave;mes d'injection SQL nous utilisons syst&eacute;matiquement des marqueurs et passons les valeurs des param&egrave;tres avec un appel &agrave; la m&eacute;thode <code class="code" id="bqkqde_61">setParameter</code>.</p><div class="code-block" data-lang="php">
// dans scr/Repository/PostRepository.php

public function findPostByTheme(Theme $theme)
{
    return $this-&gt;createQueryBuilder('p')
                -&gt;where('p.theme = :theme')
                -&gt;setParameter('theme', $theme)
                -&gt;getQuery()-&gt;getResult();
}
</div><p id="bqkqde_60">Ici encore, un simple <code class="code" id="bqkqde_62">findBy</code> aurait produit le m&ecirc;me r&eacute;sultat.</p></section><section class="chapter"><h3 id="requ-te-param-tr-e-autre-syntaxe" data-toc="requ-te-param-tr-e-autre-syntaxe">Requ&ecirc;te param&eacute;tr&eacute;e autre syntaxe</h3><p id="bqkqde_63">Plut&ocirc;t qu'une cha&icirc;ne de caract&egrave;re, nous pouvons utiliser des entiers en guise de marqueurs.</p><div class="code-block" data-lang="php">
// dans scr/Repository/PostRepository.php

public function findPostByTheme(Theme $theme)
{
    return $this-&gt;createQueryBuilder('p')
                -&gt;where('p.theme = ?1')
                -&gt;setParameter(1, $theme)
                -&gt;getQuery()-&gt;getResult();
}
</div></section><section class="chapter"><h3 id="jointures" data-toc="jointures">Jointures</h3><p id="bqkqde_65">Le code des jointures est tr&egrave;s diff&eacute;rent de ce que nous connaissons avec SQL. QueryBuilder requ&ecirc;te sur des entit&eacute;s et les conditions de jointure sont d&eacute;j&agrave; d&eacute;finies au sein de l'association.</p><p id="bqkqde_66">Pour faire une jointure, il suffit donc de pr&eacute;ciser le nom de la propri&eacute;t&eacute; qui porte l'association au sein de la classe propri&eacute;taire et de donner un alias &agrave; cette entit&eacute; li&eacute;e.</p><div class="code-block" data-lang="php">
// dans scr/Repository/PostRepository.php

public function findPostsByThemeName(string $name)
{
    return $this-&gt;createQueryBuilder('p')
                -&gt;join('p.theme', 't')
                -&gt;where('t.themeName = :theme')
                -&gt;setParameter('theme', $name)
                -&gt;getQuery()-&gt;getResult();
}
</div><p id="bqkqde_68"><span class="control" id="bqkqde_70">Le contr&ocirc;leur</span></p><div class="code-block" data-lang="php">
#[Route(
    '/post/by-them/{themeName}', 
    name: 'app_post_by_theme_name'
)]
public function byThemeName(
    PostRepository $repository,
    string $themeName
): Response
{
    return $this-&gt;render('post/index.html.twig', [
        'posts' =&gt; $repository-&gt;findPostsByThemeName($themeName),
        'themeName' =&gt; $themeName,
    ]);
}
</div></section></section><section class="chapter"><h2 id="les-m-thodes-du-querybuilder" data-toc="les-m-thodes-du-querybuilder">Les M&eacute;thodes du QueryBuilder</h2><p id="bqkqde_71">R&eacute;sum&eacute; des M&eacute;thodes Principales</p><div class="table-wrapper"><table class="wide" id="bqkqde_72"><thead><tr class="ijRowHead" id="bqkqde_74"><th id="bqkqde_86"><p>M&eacute;thode</p></th><th id="bqkqde_87"><p>Description</p></th></tr></thead><tbody><tr id="bqkqde_75"><td id="bqkqde_88"><p>select(), addSelect()</p></td><td id="bqkqde_89"><p>S&eacute;lection des champs/colonnes</p></td></tr><tr id="bqkqde_76"><td id="bqkqde_90"><p>from()</p></td><td id="bqkqde_91"><p>Source de donn&eacute;es</p></td></tr><tr id="bqkqde_77"><td id="bqkqde_92"><p>where()</p></td><td id="bqkqde_93"><p>Ajout de conditions simples</p></td></tr><tr id="bqkqde_78"><td id="bqkqde_94"><p>andWhere()</p></td><td id="bqkqde_95"><p>Conditions suppl&eacute;mentaires (ET)</p></td></tr><tr id="bqkqde_79"><td id="bqkqde_96"><p>orWhere()</p></td><td id="bqkqde_97"><p>Conditions suppl&eacute;mentaires (OU)</p></td></tr><tr id="bqkqde_80"><td id="bqkqde_98"><p>join(), leftJoin()</p></td><td id="bqkqde_99"><p>Jointure entre entit&eacute;s</p></td></tr><tr id="bqkqde_81"><td id="bqkqde_100"><p>groupBy()</p></td><td id="bqkqde_101"><p>Regroupement</p></td></tr><tr id="bqkqde_82"><td id="bqkqde_102"><p>having()</p></td><td id="bqkqde_103"><p>Conditions apr&egrave;s regroupement</p></td></tr><tr id="bqkqde_83"><td id="bqkqde_104"><p>orderBy()</p></td><td id="bqkqde_105"><p>Tri des r&eacute;sultats</p></td></tr><tr id="bqkqde_84"><td id="bqkqde_106"><p>setFirstResult()</p></td><td id="bqkqde_107"><p>Offset (pagination)</p></td></tr><tr id="bqkqde_85"><td id="bqkqde_108"><p>setMaxResults()</p></td><td id="bqkqde_109"><p>Limite de r&eacute;sultats</p></td></tr></tbody></table></div><section class="chapter"><h3 id="select" data-toc="select">Select</h3><p id="bqkqde_110">Si nous ne s&eacute;lectionnons que quelques &eacute;l&eacute;ments d'une entit&eacute;, le r&eacute;sultat ne sera plus un tableau d'entit&eacute;s, mais un simple tableau ordinal de tableaux associatifs.</p><div class="code-block" data-lang="php">
public function findOnlyIdAnTitle(): array{
        $qb = $this-&gt;createQueryBuilder('p')
            -&gt;select('p.id', 'p.title')
        return $qb-&gt;getQuery()-&gt;getResult();
    }
</div><figure id="bqkqde_112"><img alt="CleanShot 2025-01-27 at 17.06.00@2x.png" src="images/CleanShot%202025-01-27%20at%2017.06.00%402x.png" title="CleanShot 2025-01-27 at 17.06.00@2x.png" width="1814" height="798"></figure><p id="bqkqde_113">La m&eacute;thode <code class="code" id="bqkqde_114">addSelect</code> permet d'ajouter des &eacute;l&eacute;ments &agrave; une s&eacute;l&eacute;ction d&egrave;ja &eacute;tablie, tr&egrave;s utile lorsque l'on veut ajouter des &eacute;l&eacute;ments en fonction d'une condition (pour un formulaire de recherche par exemple).</p></section></section><section class="chapter"><h2 id="group-by" data-toc="group-by">Group By</h2><p id="bqkqde_115">Notons que Doctrine supporte les fonctions d'agr&eacute;gation <code class="code" id="bqkqde_118">SQL</code>. Le regroupement consolidant les donn&eacute;es de plusieurs entit&eacute;s, le r&eacute;sultat sera une collection de tableaux associatifs.</p><div class="code-block" data-lang="php">
// Dans src/Repository/TagRepository.php

public function countPostsByTags(): array{
    return $this-&gt;createQueryBuilder('t')
        -&gt;select('t.tagName, COUNT(p.id) as postCount')
        -&gt;Join('t.posts', 'p')
        -&gt;groupBy('t.id')
        -&gt;getQuery()
        -&gt;getResult();
}
</div><figure id="bqkqde_117"><img alt="CleanShot 2025-01-27 at 17.16.07@2x.png" src="images/CleanShot%202025-01-27%20at%2017.16.07%402x.png" title="CleanShot 2025-01-27 at 17.16.07@2x.png" width="1814" height="1460"></figure></section><section class="chapter"><h2 id="la-r-cup-ration-des-r-sultats" data-toc="la-r-cup-ration-des-r-sultats">La r&eacute;cup&eacute;ration des r&eacute;sultats</h2><p id="bqkqde_119">La m&eacute;thode <code class="code" id="bqkqde_121">getResult</code> tente de retourner un tableau d'entit&eacute;s (nous avons vu qu'il est des cas o&ugrave; elle ne peut le faire). Il existe cependant d'autres m&eacute;thodes de r&eacute;cup&eacute;ration.</p><dl id="bqkqde_120" data-style="title-top"><dt id="bqkqde_122" data-expandable="false"><code class="code" id="bqkqde_133">getOneOrNullResult()</code></dt><dd><p id="bqkqde_131">R&eacute;cup&egrave;re un seul r&eacute;sultat sous la forme d'une entit&eacute; ou null s'il n'y a pas de donn&eacute;es.</p><p id="bqkqde_132">Si la requ&ecirc;te contient plus d'une ligne alors une exception <code class="code" id="bqkqde_134">NonUniqueResultException</code> est lev&eacute;e.</p></dd><dt id="bqkqde_123" data-expandable="false"><code class="code" id="bqkqde_139">getSingleResult()</code></dt><dd><p id="bqkqde_136">R&eacute;cup&egrave;re un seul r&eacute;sultat sous la forme d'une entit&eacute;.</p><p id="bqkqde_137">Si la requ&ecirc;te contient plus d'une ligne, une exception <code class="code" id="bqkqde_140">NonUniqueResultException</code> est lev&eacute;e.</p><p id="bqkqde_138">Si la requ&ecirc;te ne contient pas de donn&eacute;es, une exception <code class="code" id="bqkqde_141">NoResultException</code> est lev&eacute;e.</p></dd><dt id="bqkqde_124" data-expandable="false"><code class="code" id="bqkqde_145">getArrayResult()</code></dt><dd><p id="bqkqde_143">R&eacute;cup&egrave;re les r&eacute;sultats sous la forme d'un tableau ordinal de tableaux associatifs</p><p id="bqkqde_144">Dans le cas de d&eacute;veloppement d'une API, il est plus simple de s&eacute;rialiser un tel tableau en JSON</p></dd><dt id="bqkqde_125" data-expandable="false"><code class="code" id="bqkqde_149">getSingleScalarResult()</code></dt><dd><p id="bqkqde_147">R&eacute;cup&egrave;re une seule valeur</p><p id="bqkqde_148">Si la requ&ecirc;te ne contient pas de donn&eacute;es, une exception <code class="code" id="bqkqde_150">NoResultException</code> est lev&eacute;e.</p></dd><dt id="bqkqde_126" data-expandable="false"><code class="code" id="bqkqde_153">getScalarResult()</code></dt><dd><p id="bqkqde_152">R&eacute;cup&egrave;re une ligne sous la forme d'un tableau associatif</p></dd><dt id="bqkqde_127" data-expandable="false"><code class="code" id="bqkqde_157">getSingleColumnResult()</code></dt><dd><p id="bqkqde_155">R&eacute;cup&egrave;re les valeurs d'une seule colonne sous forme de tableau.</p><div class="code-block" data-lang="php">
$qb = $this-&gt;createQueryBuilder('p')
-&gt;select('p.title');
$titles = $qb-&gt;getQuery()-&gt;getSingleColumnResult();
</div></dd><dt id="bqkqde_128" data-expandable="false"><code class="code" id="bqkqde_161">iterate()</code></dt><dd><p id="bqkqde_159">Permet d'it&eacute;rer sur les r&eacute;sultats sans les charger tous en m&eacute;moire (utile pour de grandes quantit&eacute;s de donn&eacute;es).</p><div class="code-block" data-lang="php">
$qb = $this-&gt;createQueryBuilder('p')
          -&gt;where('p.publishedAt IS NOT NULL')
$iterableResult = $qb-&gt;getQuery()-&gt;iterate();
foreach ($iterableResult as $row) {
  $post = $row[0];
  // Traitez chaque entité ici
}
</div></dd><dt id="bqkqde_129" data-expandable="false"><code class="code" id="bqkqde_165">toIterable()</code></dt><dd><p id="bqkqde_163">Similaire &agrave; iterate(), mais plus simple d&rsquo;utilisation.</p><div class="code-block" data-lang="php">
$qb = $this-&gt;createQueryBuilder('p')
          -&gt;where('p.publishedAt IS NOT NULL')
foreach ($qb-&gt;getQuery()-&gt;toIterable() as $post) {
  // Traitez chaque entité ici
}
</div></dd></dl></section><section class="chapter"><h2 id="exercices" data-toc="exercices">Exercices</h2><ul class="list _bullet" id="bqkqde_166"><li class="list__item" id="bqkqde_167"><p>Afficher la liste des auteurs ayant post&eacute; sur un tag pass&eacute; en argument.</p></li><li class="list__item" id="bqkqde_168"><p>Afficher le pourcentage de posts non encore publi&eacute;s.</p></li><li class="list__item" id="bqkqde_169"><p>Afficher les n derniers commentaires (n &eacute;tant pass&eacute; en argument).</p></li></ul></section><div class="last-modified">Last modified: 01 février 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="004-05-le-cycle-de-vie-des-entites.html" class="navigation-links__prev">Le cycle de vie des entit&eacute;s</a><a href="004-07-entites-et-heritage.html" class="navigation-links__next">Entit&eacute;s et h&eacute;ritage</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b575/app.js"></script></body></html>